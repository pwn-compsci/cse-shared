<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture</title>
    
    <style>
        :root {
            --progress-bar-height: 20px;
        }
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        #level-info {
            padding: 10px;
            background-color: #333;
            color: #00a3e0;
            font-size: 1.7rem;
            font-weight: bold;
            font-family: 'Space Grotesk', sans-serif;
            text-align: left;            
        }
        #player-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid grey;
            box-sizing: border-box;
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 540px; /* Ensure minimum height for percentage calculations */
        }
        #iframe_player {
            width: 100%;
            height: 100%;
        }
        #iframe_player.iframe-mode {
            position: absolute;
            top: 0;
            left: 0;
        }
        #iframe_player iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #mcq-container {
            display: none;
            width: 100%;
            background: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            border-top: 2px solid #404040;
            max-height: 50vh;
            overflow-y: auto;
        }
        #mcq-border {
            background-color: #1a1a1a;
            margin: 0;
            padding: 20px 20px 5px 5px;
            border: none;
            border-radius: 0;
            width: 100%;
            box-sizing: border-box;
        }
        .mcq-field {
            margin: 15px 0;
            padding: 20px;
            background-color: #2a2a2a;
            color: #ffffff;
            border: 1px solid #404040;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            flex: 1 1 400px;
            min-width: 350px;
            max-width: calc(50% - 10px);
            box-sizing: border-box;
        }
        @media (max-width: 800px) {
            .mcq-field {
                flex: 1 1 100%;
                max-width: 100%;
                min-width: 0;
            }
        }
        .mcq-question {
            font-size: 16px;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 15px;
        }
        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 0;
            width: 100%;
        }
        .mcq-options label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background-color: #333333;
            border: 1px solid #555555;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            color: #ffffff;
            width: 100%;
            box-sizing: border-box;
        }
        .mcq-options label:hover {
            background-color: #404040;
        }
        .mcq-options input[type="radio"] {
            margin: 0;
            margin-top: 2px;
            width: 16px;
            height: 16px;
        }
        .mcq-options .option-letter {
            font-weight: bold;
            color: #ffffff;
            background-color: #555555;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            min-width: 20px;
            text-align: center;
        }
        .mcq-options .option-text {
            flex: 1;
            color: #ffffff;
        }
        #progress-container {
            width: 100%;
            height: var(--progress-bar-height);
            background-color: grey;
        }        
        .progress-bar {
            position: absolute;
            height: var(--progress-bar-height);
            opacity: 0.5;
        }
        .progress-bar.invalid-coverage {
            background-color: #f44336;
        }
        .progress-bar.valid-coverage {
            background-color: #4caf50;
        }
        .modal {
            color: white;
            background-color: #333;
            font-family: monospace;
            font-size: 1.5rem;
            text-align: center;
        }
        .modal::backdrop {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .modal-field {
            padding: 10px;
            background-color: white;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            z-index: 10000;
        }
        .modal-close:hover {
            cursor: pointer;
        }
        .modal-close:focus {
            outline: none;
        }
        .field-copy {
            padding: 10px;
            margin-left: 20px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
        .field-copy:hover {
            cursor: pointer;
            background-color: #ccc;
        }
        .field-copy:active {
            background-color: lightblue;
        }
        .field-submit {
            padding: 10px;
            margin-left: 20px;
            color: white;
            font-weight: bold;            
            background-color: transparent;
            border: 1px solid #ffffff;
            border-radius: 10px;
        }
        .field-submit:hover {
            cursor: pointer;
            background-color: #6c757d;
        }
        .field-submit:active {
            background-color: lightblue;
        }
        
        .loading-modal {            
            font-family: 'Space Grotesk';
            font-weight: 500;
            font-size: 2em;
            color: #78be20;
            background-color: #222;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px 16px;
        }
        .mcq-fields-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }
        #flag-submitted-modal {
            display: none;
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 4px 24px rgba(0,0,0,0.4);
            border-radius: 12px;
            background: #222;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 26px 16px 4px 16px;
            border: 1px solid #ccc;
        }
        #flag-submitted-close {
            position: absolute;
            top: 8px;
            right: 12px;            
        }
        #flag-submitted-modal .modal-field {
            color: #4caf50;
            font-size: 1.3em;
            border: none;
            background: #222;
            margin-bottom: 10px;
        }
        #flag-submitted-modal.warning .modal-field {
            color: #ff9800;
            background: #222;
            border: none;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        #flag-submitted-modal.error .modal-field {
            color: #f44336;
            background: #222;
            border: none;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .mcq-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 3px;
            padding-bottom: 3px;
            border-bottom: 1px solid #404040;
        }
        .mcq-title {
             color: #00a3e0;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        .mcq-points {
            color: #999999;
            font-size: 14px;
        }
        #mcq-container .modal-close {
            position: static;
            background: #333333;
            /* border: 1px solid #555555; */
            /* border-radius: 6px; */
            color: #ffffff;
            /* padding: 8px 12px; */
            font-size: 14px;
            cursor: pointer;
            z-index: auto;
        }
        /* #mcq-container .modal-close:hover {
            background: #404040;
        } */
         #mcq-container .mcq-submit-btn {
            background-color: #007acc;
            border: 1px solid #007acc;
            color: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            padding: 12px 40px;
            margin-top: 0px;
            margin-bottom: 0px;
         }
        #mcq-container .mcq-submit-btn:hover,
        #mcq-container .modal-close:hover {
            background-color: #005f99;
            border-color: #005f99;
        }
        /* Code highlighting for MCQ content */
        #mcq-container pre {
            background-color: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Courier New', Monaco, 'Lucida Console', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: #d4d4d4;
        }
        #mcq-container code {
            background-color: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: 'Courier New', Monaco, 'Lucida Console', monospace;
            font-size: 13px;
            color: #d4d4d4;
        }
        #mcq-container pre code {
            background: transparent;
            border: none;
            padding: 0;
            color: inherit;
        }
        /* Syntax highlighting colors */
        #mcq-container .hljs-keyword {
            color: #569cd6;
        }
        #mcq-container .hljs-string {
            color: #ce9178;
        }
        #mcq-container .hljs-number {
            color: #b5cea8;
        }
        #mcq-container .hljs-comment {
            color: #6a9955;
        }
        #mcq-container .hljs-type {
            color: #4ec9b0;
        }
        #mcq-container .hljs-function {
            color: #dcdcaa;
        }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Enhanced YouTube API loading detection and debugging
        let ytApiLoaded = false;
        let ytPlayerReady = false;
        let VIDEO_ID = "{{ youtube_id }}"; // Will be set when template renders
        let IFRAME_URL = "{{ iframe_url }}"
        var videoCompleted = false; 
        var csrf_token = ""
        
        // MCQ_QUESTIONS is set from the Jinja template variable 'mcqs'
        const MCQ_QUESTIONS = {{ mcqs|tojson }}; 
        console.log("MCQ_QUESTIONS value:", MCQ_QUESTIONS);

        // This function is called automatically by YouTube when the API is ready
        if (IFRAME_URL && IFRAME_URL.trim() !== "" && !IFRAME_URL.includes("{{") && !IFRAME_URL.includes("}}")) {
            // If iframe_url is set, embed the iframe and skip YouTube API
            document.addEventListener("DOMContentLoaded", function() {
                const playerDiv = document.getElementById("player");
                playerDiv.style.background = "#1a1a1a"
                playerDiv.style.width = "100%";
                playerDiv.style.height = "100%";
                const wrapperDiv = document.createElement("div");
                wrapperDiv.id = "iframe_player";
                wrapperDiv.style.width = "100%";
                wrapperDiv.style.height = "100%";
                wrapperDiv.style.position = "relative";
                wrapperDiv.style.background = "transparent";
                while (playerDiv.firstChild) {
                    wrapperDiv.appendChild(playerDiv.firstChild);
                }
                playerDiv.appendChild(wrapperDiv);                
                wrapperDiv.classList.add("iframe-mode"); // Add class for iframe-specific styling
                wrapperDiv.innerHTML = `<iframe src="${IFRAME_URL}" style='width: 100%; height: 100%;' id='media_iframe' frameborder="0" allowfullscreen loading='lazy' allow='geolocation *; microphone *; camera *; midi *; encrypted-media *; autoplay *; clipboard-write *; display-capture *'></iframe>`;
                
                // Add error handling for iframe loading
                const iframe = document.getElementById("media_iframe");
                iframe.onload = function() {
                    console.log("Iframe loaded successfully");
                };
                iframe.onerror = function() {
                    console.error("Failed to load iframe content");
                    playerDiv.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                        Failed to load media content. This may be due to CORS restrictions or X-Frame-Options policy.
                        <br><br>
                        <a href="${IFRAME_URL}" target="_blank" style="color: #00a3e0;">Click here to open in a new tab</a>
                    </div>`;
                };
                
                const statusBar = document.getElementById("progress-container");
                statusBar.style.display = "none"; // Hide the progress bar for iframe mode
                
                iframe.addEventListener("load", function() {
                    try {
                        const appContainers = iframe.contentWindow.document.querySelectorAll(".app-container");
                        appContainers.forEach(container => {
                            container.style.backgroundColor = "#1a1a1a";
                        });
                        console.log("@@@@@@@@@@@@@@@@@@ loaded iframe background attempt", e);
                    } catch (e) {
                        // Cross-origin, ignore
                        console.log("***** Unable to access iframe contents for background color change:", e);
                    }
                });
                console.log("Embedded iframe with URL:", IFRAME_URL);
                
            });
            // Prevent further YouTube API initialization
            window.onYouTubeIframeAPIReady = function() {};

            if (Array.isArray(MCQ_QUESTIONS) && MCQ_QUESTIONS.length > 0) {
                document.addEventListener("DOMContentLoaded", function() {
                    videoCompleted = true; 
                    const mcqModal = document.getElementById("mcq-container");                        
                    mcqModal.style.display = "block";                
                });
            }
            
            loadChallengeData();
            
            
        } else if (VIDEO_ID && VIDEO_ID.trim() !== "" && !VIDEO_ID.includes("{{") && !VIDEO_ID.includes("}}")) {
           
            // Proceed with YouTube API initialization
            console.log("YouTube API will be initialized with video ID:", VIDEO_ID);
            window.onYouTubeIframeAPIReady = function() {
                console.log("YouTube API is ready!");
                console.log("VIDEO_ID value:", VIDEO_ID);
                ytApiLoaded = true;
                
                // Check if we have a valid video ID (more flexible validation)
                if (!VIDEO_ID || VIDEO_ID.trim() === "" || VIDEO_ID.includes("{{") || VIDEO_ID.includes("}}")) {
                    console.error("No valid YouTube video ID found:", VIDEO_ID);
                    document.getElementById("level-info").innerHTML = "Error: No video ID provided. Please check the lecture configuration.";
                    return;
                }
                
                console.log("Creating YouTube player with video ID:", VIDEO_ID);
                initializeYouTubePlayer();
            };
            
            function initializeYouTubePlayer() {
                try {
                    player = new YT.Player("player", {
                        height: "100%",
                        width: "100%",
                        videoId: VIDEO_ID,
                        playerVars: {
                            controls: 1,
                            rel: 0,
                            enablejsapi: 1,
                            origin: window.location.origin
                        },
                        events: {
                            onReady: onPlayerReady,
                            onStateChange: onPlayerStateChange,
                            onPlaybackRateChange: onPlayerPlaybackRateChange,
                            onError: onPlayerError
                        }
                    });
                    console.log("YouTube player created successfully");
                } catch (error) {
                    console.error("Error creating YouTube player:", error);
                    document.getElementById("level-info").innerHTML = "Error creating video player. Please refresh the page.";
                }
            }
            
            function onPlayerError(event) {
                console.error("YouTube player error:", event.data);
                let errorMessage = "Video player error: ";
                switch(event.data) {
                    case 2:
                        errorMessage += "Invalid video ID";
                        break;
                    case 5:
                        errorMessage += "Video cannot be played in HTML5 player";
                        break;
                    case 100:
                        errorMessage += "Video not found or private";
                        break;
                    case 101:
                    case 150:
                        errorMessage += "Video owner does not allow embedding";
                        break;
                    default:
                        errorMessage += "Unknown error (" + event.data + ")";
                }
                document.getElementById("level-info").innerHTML = errorMessage + ". Please contact your instructor.";
            }
            
            // Fallback check if YouTube API doesn't load within 5 seconds
            setTimeout(function() {
                if (!ytApiLoaded) {
                    console.error("YouTube API failed to load within 5 seconds");
                    document.getElementById("level-info").innerHTML = "Failed to load video player. Please check your internet connection and refresh the page.";
                    
                    // Try manual initialization as backup
                    if (typeof YT !== "undefined" && YT.Player) {
                        console.log("YouTube API available, trying manual initialization");
                        ytApiLoaded = true;
                        // Use the same improved validation
                        if (VIDEO_ID && VIDEO_ID.trim() !== "" && !VIDEO_ID.includes("{{") && !VIDEO_ID.includes("}}")) {
                            initializeYouTubePlayer();
                        }
                    }
                }
            }, 5000);
            
            // Additional check after DOM is loaded
            document.addEventListener("DOMContentLoaded", function() {
                console.log("DOM loaded, checking YouTube API status");
                console.log("YT object:", typeof YT);
                console.log("VIDEO_ID:", VIDEO_ID);
                
                setTimeout(function() {
                    if (!ytPlayerReady && ytApiLoaded) {
                        console.warn("YouTube API loaded but player not ready, checking...");
                        if (typeof player === "undefined" || !player) {
                            console.log("Player not initialized, attempting retry");
                            // Use the same improved validation
                            if (VIDEO_ID && VIDEO_ID.trim() !== "" && !VIDEO_ID.includes("{{") && !VIDEO_ID.includes("}}")) {
                                initializeYouTubePlayer();
                            }
                        }
                    }
                }, 2000);
            });
        } else {
            // If no valid video ID, show error and skip YouTube API
            console.error("No valid YouTube video ID found:", VIDEO_ID);
            document.getElementById("level-info").innerHTML = "Error: No video ID provided. Please check the lecture configuration.";
        }
        
        
        async function loadChallengeData() {
            csrf_token = window.parent.init.csrfNonce
            try {
                const response = await fetch("/active-module", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });
                let data = await response.json();
                console.log("Challenge data loaded:", data);
                if (data.c_current) {
                    curChal = data.c_current;    
                }
                if (data.c_next) {
                    nextChal = data.c_next;                    
                }
            } catch (error) {
                console.log("Error loading challenge data:", error);
            }
            
            const levelInfo = document.getElementById("level-info");
            if (curChal && curChal.challenge_name && curChal.module_name) {
                console.log("Current challenge:", curChal);                
                levelInfo.innerHTML = `
                    ${curChal.challenge_name}  <span style='font-size:1.3rem'>(${curChal.module_name})</span>
                `;
            } else {
                levelInfo.innerHTML = `Failed to load challenge information...`;
            }            
        }
    </script>
</head>
<body>
    
    <div id="level-info">
        Loading challenge information...
    </div>
    <script>
        // Show error if challenge info doesn't load in 10 seconds
        setTimeout(function() {
            var levelInfo = document.getElementById("level-info");
            if (levelInfo && levelInfo.textContent.trim().startsWith("Loading challenge")) {
            levelInfo.innerHTML = "Failed to load lecture information. Please refresh the page and try again. The page will refresh automatically in 5 seconds.";
            setTimeout(function() {
                location.reload();
            }, 5000);
            }
        }, 7000);
    </script>
    <div id="player-container">
        <div id="player"></div>
    </div>
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    
    <div id="mcq-container">
        <div id="mcq-border">
            <div class="mcq-header">
                <h2 class="mcq-title">Knowledge Check Questions</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="modal-close" onclick="document.getElementById('mcq-container').style.display='none'">&times;</button>
                </div>
            </div>
            <form method="dialog" id="mcq-form">
                <input type="hidden" name="pwnid" id="pwnid" value="">                
                <div class="mcq-fields-flex">
                    {% for mcq in mcqs %}
                    <div class="mcq-field" id="mcq-field-{{ mcq.id }}">
                        <div class="mcq-incorrect" id="mcq-incorrect-{{ mcq.id }}"></div>
                        <div class="mcq-question" id="mcq-question-{{ mcq.id }}">
                            <span id="mcq-question-incorrect-{{ mcq.id }}" style="color: red; display: none; font-size: 2em; vertical-align: middle;">❌</span>
                            <span id="mcq-question-correct-{{ mcq.id }}" style="color: green; display: none; font-size: 2em; vertical-align: middle;">✅</span>
                            {{ mcq.question|safe }}
                        </div>
                        <div class="mcq-options" id="mcq-options-{{ mcq.id }}">
                            {% for option in mcq.options %}
                            {% set option_letter = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[loop.index0] %}
                            <label>
                                <input type="radio" name="mcq_answer_{{ mcq.id }}" value="{{ option.value }}">
                                <span class="option-letter">{{ option_letter }}</span>
                                <span class="option-text">{{ option.text|safe }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" class="field-submit mcq-submit-btn" >Submit</button>
            </form>
        </div>
    </div>
    
    <style>
        
    </style>
    <div id="flag-submitted-modal" class="modal">
        <button id="flag-submitted-close" class="modal-close">&times;</button>
        <div class="modal-field">
            Flag submitted successfully!
        </div>
    </div>
    <dialog id="flag-modal" class="modal">
        <button class="modal-close" onclick="document.getElementById('flag-modal').close()">&times;</button>
        <div class="modal-field">
            <span id="flag-text"></span>
            <button class="field-copy" onclick="navigator.clipboard.writeText(document.getElementById('flag-text').textContent)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>            
        </div>

        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
            <button class="field-submit" id="submit-flag-btn" type="button">Submit Flag</button>
            <button class="field-submit" id="submit-flag-next-btn" type="button">Submit Flag and Start Next Level</button>
        </div>
    </dialog>
   
    <dialog id="message-modal-content" class="modal">
        <button class="modal-close" onclick="document.getElementById('message-modal-content').close()">&times;</button>
        <div class="modal-field" style="color: #f44336;">
            Incorrect. Please re-watch the video and try again.
        </div>
    </dialog>
    <dialog id="loading-modal" class="loading-modal">
        <div class="loading-field" >
            Loading next challenge, please wait...
        </div>
    </dialog>
    
    <script>
        
        
        // Set the value of the hidden input to window.parent.init.userId if available
        document.addEventListener("DOMContentLoaded", function() {
            var userId = window.parent && window.parent.init && window.parent.init.userId;
            if (userId) {
                document.getElementById("pwnid").value = userId;
            }
        });

        document.getElementById('mcq-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!videoCompleted){
                const messageModal = document.getElementById("message-modal-content");
                const modalField = messageModal.querySelector('.modal-field');
                modalField.textContent = "ERROR: You must watch the video in full to obtain the flag. Please refresh the page and watch the video in full to obtain the flag (you may increase the video speed).";
                messageModal.showModal();
                return;
            }
            console.log("Submitting MCQ answer...");
            const form = event.target;
            const question_responses = [];

            // For each group of radio buttons (one per MCQ)
            const mcqFields = form.querySelectorAll('.mcq-field');
            mcqFields.forEach(field => {
                const mcqId = field.id.replace('mcq-field-', '');
                const answer = field.querySelector('input[type="radio"]:checked');
                if (answer) {
                    question_responses.push({
                        question_id: mcqId,
                        answer: answer.value
                    });                    
                } else {
                    const messageModal = document.getElementById("message-modal-content");
                    const modalField = messageModal.querySelector('.modal-field');
                    modalField.textContent = "Please select an answer for each question before submitting.";
                    messageModal.showModal();
                    return;
                }                    
            });
            
            fetch("knowledge_check", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    responses: question_responses
                })
            })
            .then(response => response.json())
            .then(data => {                
                if (data.question_eval) {
                    console.log(data.question_eval);
                    Object.entries(data.question_eval).forEach(([mcqId, value]) => {
                        const incorrectIcon = document.getElementById(`mcq-question-incorrect-${mcqId}`);
                        const correctIcon = document.getElementById(`mcq-question-correct-${mcqId}`);
                        if (value.status === "incorrect") {
                            if (incorrectIcon) incorrectIcon.style.display = "";
                            if (correctIcon) correctIcon.style.display = "none";
                        } else if (value.status === "correct") {
                            if (correctIcon) correctIcon.style.display = "";
                            if (incorrectIcon) incorrectIcon.style.display = "none";
                        }
                    });
                }
                if (data.status === "correct") {
                    document.querySelectorAll('.mcq-incorrect').forEach(el => el.style.display = "none");
                    document.querySelectorAll('.mcq-correct').forEach(el => el.style.display = "inline");
                    const flagModal = document.getElementById("flag-modal");
                    const flagText = document.getElementById("flag-text");
                    flagText.textContent = data.flag;
                    flagModal.showModal();                    
                    return;
                }
                if (data.status === "incorrect") {                    
                    const incorrectModal = document.getElementById("message-modal-content");
                    const modalField = incorrectModal.querySelector('.modal-field');
                    modalField.textContent = data.message;
                    if (data.answer_attempts == data.max_mcq_attempts){
                        incorrectModal.querySelector('.modal-close').onclick = () => {
                            location.reload();                            
                        }
                    } else {
                        incorrectModal.querySelector('.modal-close').onclick = () => {
                            document.getElementById('message-modal-content').close();
                        }
                    }
                    incorrectModal.showModal();
                    // data.question_eval = {"question_0": {"status": "incorrect", "message": "Incorrect answer. Please try again."}}]
                    
                    return;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while submitting your answer. Please try again.");
            });

        });
        async function tryConnect() {
            let checknbr = 0;
            while (true) {
                try {                        
                    const response = await fetch("/workspace/code", { method: "GET" });
                    if (response.ok) {
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Pause 1 second between checks
                        if (window.location.href.includes("/workspace/challenge")){
                            console.log("Workspace is ready, redirecting to /workspace/code");
                            window.parent.location.href = "/workspace/code";
                        } else {
                            console.log("Workspace is ready, reloading the page");
                            window.parent.location.reload();
                        }
                        console.log(response)                        
                        break;
                    } else {
                        checknbr++;
                        loadingModal.querySelector('.loading-field').textContent = `Waiting for workspace to be ready, attempt #${checknbr}...Please wait.`;
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Pause 1 second between checks
                    }
                } catch (e) {
                    console.log("error checking workspace readiness:", e);
                    break;
                }
            }
            document.getElementById("loading-modal").close();            
        }
        function submitFlag(){
            const flagText = document.getElementById("flag-text").textContent;
            /*{challenge_id: "17289", submission: "asdfasdf"} */       
            const loadingModal = document.getElementById("loading-modal");
            loadingModal.querySelector('.loading-field').textContent = "Submitting flag, please wait...";
            loadingModal.showModal();     
            console.log("csrf_token=", csrf_token);
            return fetch("/api/v1/challenges/attempt", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Csrf-Token": csrf_token
                },
                body: JSON.stringify({ 
                    challenge_id: curChal.challenge_id,     // 17360
                    submission: flagText
                 })
            }).then(response => response.json())
            .then(data => {
                console.log(data);
                success = data.success;
                data = data.data; 
                loadingModal.close();
                // Show the flag submitted message modal at the top of the frame
                const flagSubmittedModal = document.getElementById("flag-submitted-modal");
                flagSubmittedModal.style.display = "flex";
                // Hide modal when X is clicked
                document.getElementById("flag-submitted-close").onclick = () => {
                    flagSubmittedModal.style.display = "none";
                };
                const flagModal = document.getElementById("flag-modal");
                if (data && data.status === "correct") {
                    flagSubmittedModal.querySelector('.modal-field').textContent = "Flag submitted successfully!";
                    flagModal.close();
                    return true;
                } else if (data && data.status ==="already_solved") {
                    flagSubmittedModal.querySelector('.modal-field').textContent = "Already submitted this flag.";                    
                    flagSubmittedModal.classList.add("warning");                 
                    flagModal.close();
                    return true;
                } else if (data) {
                    flagSubmittedModal.querySelector('.modal-field').textContent = "Error submitting flag: " + data.message + ". Please try to submit the flag manually.";                    
                    flagSubmittedModal.classList.add("error");   
                    return false;
                } else {
                    
                }
            }).catch(error => {
                const flagSubmittedModal = document.getElementById("flag-submitted-modal");
                flagSubmittedModal.style.display = "flex";
                flagSubmittedModal.querySelector('.modal-field').textContent = "An error occurred while submitting flag ";                    
                flagSubmittedModal.classList.add("error");   
                console.log("Error:", error);
                //alert("An error occurred while submitting the flag. Please try again.");
                return false;
            });
        }
        function loadNextChallenge() {
            if (nextChal) {
                const flagSubmittedModal = document.getElementById("flag-submitted-modal");
                flagSubmittedModal.style.display = "none";                 
                const loadingModal = document.getElementById("loading-modal");
                loadingModal.querySelector('.loading-field').textContent = `Loading next challenge: ${nextChal.challenge_name}, please wait...`;
                loadingModal.showModal();
                console.log("Starting load of next challenge:", nextChal.challenge_name, nextChal.dojo_reference_id, nextChal.module_id);
                fetch("/pwncollege_api/v1/docker", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Csrf-Token": csrf_token
                    },
                    body: JSON.stringify({
                        challenge: nextChal.challenge_reference_id, // lec-2-1-3-2-function-params-and-
                        dojo: nextChal.dojo_reference_id,           // cse240-fc25~e7a1867c
                        module: nextChal.module_id,                 // 2-1-ll-c-intro-vars
                        practice: false
                    })
                }).then(response => response.json())
                .then(data => {
                    console.log(data);
                    success = data.success;
                    const messageModal = document.getElementById("message-modal-content");
                    const modalField = messageModal.querySelector('.modal-field');
                    
                    if (success) {
                        console.log("Received success response for next challenge load, now checking if workspace is ready...")      
                        tryConnect();
                    } else {
                        alert("Error starting next challenge: ");
                    }                    
                })
            } else {
                alert("Next challenge information is not available.");
            }
        }
        document.getElementById('submit-flag-btn').addEventListener('click', function() {
            submitFlag();
        });
        document.getElementById('submit-flag-next-btn').addEventListener('click', function() {
            submitFlag().then((result) => {
                if (result) {
                    setTimeout(loadNextChallenge, 2000);
                }                
            });            
        });
    </script>
    <script>
        
        var player;
        var interval;
        var flag;        
        var nextChal={}, curChal={};

        function onPlayerReady(event) {
            console.log("YouTube player is ready!");
            ytPlayerReady = true;
            
            interval = setInterval(() => {
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    telemetry("interval");
                }
            }, 10000);
            
            // Try to play the video
            try {
                player.playVideo();
                console.log("Video playback started");
            } catch (error) {
                console.error("Error starting video playback:", error);
            }

            loadChallengeData();
        }

        function telemetry(reason) {
            console.log(`Telemetry event: ${reason}, ${window.parent.init.userId}`);
            return fetch("telemetry", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    userId: window.parent.init.userId,
                    reason: reason,
                    player: {
                        state: player.getPlayerState(),
                        time: player.getCurrentTime(),
                        rate: player.getPlaybackRate(),
                        volume: player.getVolume(),
                        muted: player.isMuted(),
                        loaded: player.getVideoLoadedFraction(),
                        duration: player.getDuration(),
                        url: player.getVideoUrl(),
                    },
                    document: {
                        visibility: document.visibilityState,
                        fullscreen: !!document.fullscreenElement,
                        agent: navigator.userAgent,
                    },
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error && data.error === "Incorrect video") {
                    window.location.href = "..";
                }
                const progressContainer = document.getElementById("progress-container");
                progressContainer.innerHTML = "";
                const coverages = [
                    { intervals: data.coverage.invalid, type: "invalid-coverage" },
                    { intervals: data.coverage.valid, type: "valid-coverage" }
                ];
                coverages.forEach(({ intervals, type }) => {
                    intervals.forEach(([startTime, endTime]) => {
                        const start = (startTime / player.getDuration()) * 100;
                        const end = (endTime / player.getDuration()) * 100;
                        const bar = document.createElement("div");
                        bar.classList.add("progress-bar", type);
                        Object.assign(bar.style, {
                            left: `${start}%`,
                            width: `${end - start}%`,
                        });
                        bar.addEventListener("click", () => {
                            if (type === "invalid-coverage") {
                                player.seekTo(Math.max(startTime - 2, 0));
                                player.playVideo();
                            }
                            if (type === "valid-coverage") {
                                player.seekTo(Math.max(endTime - 2, 0));
                                player.playVideo();
                            }
                        });
                        bar.addEventListener("mouseover", () => {
                            bar.style.opacity = 1.0;
                        });
                        bar.addEventListener("mouseout", () => {
                            bar.style.opacity = "";
                        });
                        progressContainer.appendChild(bar);
                    });
                });
                if (data.flag) {
                    flag = data.flag;
                }
                if (data.completed){
                    videoCompleted = true; 
                }
                if (data.video && data.video == VIDEO_ID){
                    if (data.total_valid_time){
                        total_valid_time = data.total_valid_time
                    }
                }
            });
        }
        /*
            {
                "c_current": {
                    "challenge_id": 17360,
                    "challenge_name": "2.1.3.1. Globals & Locals",
                    "challenge_reference_id": "lec-2-1-3-1-globals-locals",
                    "description": "\u003Cp\u003ELecture video on Globals &amp; Locals\u003C/p\u003E",
                    "dojo_name": "CSE240-FC25 - Introduction to Programming Languages",
                    "dojo_reference_id": "cse240-fc25~e7a1867c",
                    "module_id": "2-1-ll-c-intro-vars",
                    "module_name": "2.1 C Intro and Vars LecLabs"
                },
                "c_next": {
                    "challenge_id": 17361,                                         // old challenge_id  (same)
                    "challenge_name": "2.1.3.2. Function Params and Ret Vals ",
                    "challenge_reference_id": "lec-2-1-3-2-function-params-and-",  // old challenge and next_challenge_name
                    "description": null,
                    "dojo_name": "CSE240-FC25 - Introduction to Programming Languages",
                    "dojo_reference_id": "cse240-fc25~e7a1867c",                  // old dojo 
                    "module_id": "2-1-ll-c-intro-vars",                           // old module and dojo_module
                    "module_name": "2.1 C Intro and Vars LecLabs"
                },
                "c_previous": {
                    "challenge_id": 17359,
                    "challenge_name": "2.1.3. Dec & Def Functions",
                    "challenge_reference_id": "lec-2-1-3-dec-def-functions",
                    "description": null,
                    "dojo_name": "CSE240-FC25 - Introduction to Programming Languages",
                    "dojo_reference_id": "cse240-fc25~e7a1867c",
                    "module_id": "2-1-ll-c-intro-vars",
                    "module_name": "2.1 C Intro and Vars LecLabs"
                }
            }
        */
        

        function onPlayerStateChange(event) {
            console.log("Player state changed to:", event.data);
            
            telemetry("player-state-change").then(() => {
                if (videoCompleted && event.data === YT.PlayerState.ENDED){
                    console.log("Video completed and ended, checking for MCQ questions");
                    if (MCQ_QUESTIONS && MCQ_QUESTIONS.length > 0) {
                        const mcqModal = document.getElementById("mcq-container");
                        console.log("Video completed, showing MCQ modal.");
                        console.log(mcqModal);
                        mcqModal.style.display = "block";
                    } else if (flag) {
                        console.log("No MCQ questions, showing flag modal");
                        const flagModal = document.getElementById("flag-modal");
                        const flagText = document.getElementById("flag-text");
                        flagText.textContent = flag;
                        flagModal.showModal();
                    } else {
                        console.log("No MCQ questions and no flag found");
                        alert("The video has ended but flag was not found.");
                    }
                } else if (event.data === YT.PlayerState.ENDED) { // video not completed, not enough watch time
                    console.log("Video ended but not completed (insufficient watch time)");
                    const incorrectModal = document.getElementById("message-modal-content");
                    const modalField = incorrectModal.querySelector('.modal-field');
                    modalField.textContent = "ERROR: The video has ended but it appears you fast-forwarded through it. Please refresh the page and watch the video in full to obtain the flag (you may increase the video speed)."
                    incorrectModal.showModal();
                }     
            }).catch(error => {
                console.error("Error in telemetry call:", error);
            });
            switch (event.data) {
                case YT.PlayerState.UNSTARTED:
                    color = "grey";
                    break;
                case YT.PlayerState.ENDED:
                    color = "green";
                    break;
                case YT.PlayerState.PLAYING:
                    color = "yellow";
                    break;
                case YT.PlayerState.PAUSED:
                    color = "red";
                    break;
                case YT.PlayerState.BUFFERING:
                    color = "orange";
                    break;
                case YT.PlayerState.CUED:
                    color = "purple";
                    break;
                default:
                    color = "white";
                    break;
            }
            document.getElementById("player-container").style.borderColor = color;
        }

        function onPlayerPlaybackRateChange(event) {
            telemetry("playback-rate-change");
        }

        document.addEventListener("visibilitychange", () => telemetry("document-visibility-change"));
        document.addEventListener("fullscreenchange", () => telemetry("fullscreen-change"));
    </script>
</body>
</html>